#!/usr/bin/env bash
set -euo pipefail

cd "$(git rev-parse --show-toplevel)"

# CI에서는 훅 스킵
if [ "${CI:-}" = "true" ]; then
  exit 0
fi

# pnpm 체크
if ! command -v pnpm >/dev/null 2>&1; then
  echo "pnpm이 설치되어 있지 않습니다. 설치 후 다시 시도하세요."
  exit 0
fi

# 변경 파일 감지
CHANGED_FILES="$(git diff --name-only HEAD@{1} HEAD || true)"
LOCK_CHANGED=false
PKG_CHANGED=false

if echo "$CHANGED_FILES" | grep -qE "^pnpm-lock\.yaml$"; then
  LOCK_CHANGED=true
fi

# 루트 및 패키지 하위의 모든 package.json, pnpm-workspace.yaml 감지
if echo "$CHANGED_FILES" | grep -qE "(^|/)package\.json$|^pnpm-workspace\.yaml$"; then
  PKG_CHANGED=true
fi

# 분기 실행
if [ "$PKG_CHANGED" = "true" ]; then
  echo "[post-merge] package.json / workspace 변경 감지. lockfile 갱신을 허용하여 설치합니다..."
  pnpm -w install --no-frozen-lockfile
elif [ "$LOCK_CHANGED" = "true" ]; then
  echo "[post-merge] lockfile 변경 감지. frozen 모드로 설치합니다..."
  pnpm install --frozen-lockfile
fi

exit 0